#!/usr/bin/env groovy

node {
    environment {
        DOCKER_HOST = 'unix:///var/run/docker.sock'
    }

    stage('checkout') {
        deleteDir()
        checkout scm
    }

    stage('check java') {
        sh "java -version"
    }

    stage('clean') {
        sh "chmod +x mvnw"
        sh "./mvnw clean"
    }

    stage('install tools') {
        sh "./mvnw com.github.eirslett:frontend-maven-plugin:install-node-and-yarn -DnodeVersion=v6.11.3 -DyarnVersion=v1.1.0"
    }

    stage('building and unit test docker image'){
         sh "./mvnw package -Pprod dockerfile:build"
    }

    stage('starting docker image'){
         sh "docker-compose -f src/main/docker/app-integration-test.yml up -d"
    }

    stage('integration test') {
        try {
            sh "./mvnw com.github.eirslett:frontend-maven-plugin:yarn e2e"
        } catch(err) {
            throw err
        } finally {
            sh "docker-compose -f src/main/docker/app-integration-test.yml down"
            publishHTML (target: [
                allowMissing: false,
                alwaysLinkToLastBuild: false,
                keepAll: true,
                reportDir: 'target/reports/e2e/screenshots',
                reportFiles: 'report.html',
                reportName: "E2E Report"
            ])
            junit '**/target/reports/e2e/junitresults-*.xml'
        }
    }
  }
